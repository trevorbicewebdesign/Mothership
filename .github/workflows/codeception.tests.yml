name: Run Mothership Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    # 1) Define MySQL as a job service
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: local
          MYSQL_USER: joomla
          MYSQL_PASSWORD: secret
        # wait for MySQL to become healthy
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-retries=5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2) Build only your Joomla/PHP image—no db service here
      - name: Build Joomla Image
        run: docker build -t mothership-app .

      # 3) Run the Joomla container on the host network so it can see GitHub's mysql
      - name: Start Joomla Container
        run: |
          docker run -d \
            --name joomla \
            --network host \
            -e DB_HOST=127.0.0.1 \
            -e DB_NAME=local \
            -e DB_USER=joomla \
            -e DB_PASS=secret \
            -p 8080:80 \
            mothership-app

      # 4) Wait for Joomla → MySQL connectivity
      - name: Wait for Database
        run: |
          until mysqladmin ping -h127.0.0.1 -uroot -proot --silent; do
            echo "Waiting for MySQL…"
            sleep 5
          done

      # 5) Install the extension and run your tests
      - name: Install Mothership via CLI
        run: docker exec joomla bash -lc 'php cli/joomla.php extension:install tmp/mothership'

      - name: Run Codeception Tests
        run: docker exec joomla bash -lc '/root/.composer/vendor/bin/codecept run acceptance -d -f'

      # 6) Tear it all down
      - name: Teardown
        if: always()
        run: |
          docker rm -f joomla
