name: Run Tests

on:
  push:
    branches:
      - main
      - feat-testing
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up PHP for testing tools
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, json, curl, zip

      - name: Install Composer dependencies (Codeception only)
        run: composer update --prefer-dist --no-interaction

      - name: Start Docker services (Joomla + MySQL)
        run: docker compose up -d --build

      - name: Create .env file and populate
        run: |
          touch ./tests/.env

      - name: Bootstrap Codeception
        run: ./vendor/bin/codecept bootstrap

      - name: Wait for Joomla to be ready
        run: |
          for i in {1..10}; do
            if curl -s http://localhost:8080 | grep -q "Joomla"; then
              echo "Joomla is up"
              break
            fi
            echo "Waiting for Joomla..."
            sleep 5
          done

      - name: Run Codeception Tests
        run: ./vendor/bin/codecept run acceptance -d -f

      - name: Shut down containers
        if: always()
        run: docker-compose down -v
