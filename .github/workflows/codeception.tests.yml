name: Run Mothership Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Start Docker Services
        run: docker compose up -d --build

      - name: Install Joomla
        run: |
          docker compose exec joomla php /var/www/html/cli/joomla.php site:install \
            --db-user root \
            --db-pass root \
            --db-name joomla \
            --db-host db \
            --admin-user admin \
            --admin-pass admin123 \
            --admin-email admin@example.com \
            --site-name "Mothership Test Site"
      
      - name: Wait for Joomla to be ready
        run: |
          echo "Waiting for Joomla..."
          until curl -s http://localhost:8080 | grep -q "DOCTYPE"; do
            echo "Still waiting for Joomla..."
            sleep 5
          done
          echo "Joomla is ready."
      

      - name: Install Mothership via CLI
        run: |
          docker compose exec joomla php cli/joomla.php extension:install /var/www/html/tmp/mothership

      - name: Run Codeception Acceptance Tests
        run: |
          docker compose exec joomla bash -c 'cd /var/www/html && ~/.composer/vendor/bin/codecept run acceptance -d -f'

      - name: Teardown
        if: always()
        run: docker compose down -v
