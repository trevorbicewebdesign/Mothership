name: Run Mothership Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    # 1) define a matrix over your four suites
    strategy:
      matrix:
        suite: [acceptance, functional, api, integration]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2) spin up a fresh app+db for this suite
      - name: Start Docker Services
        run: |
          docker compose -p suite-${{ matrix.suite }} up -d --build

      # 3) (optional) dump DB logs to debug startup
      - name: Dump MySQL logs
        run: docker compose -p suite-${{ matrix.suite }} logs db

      # 4) wait for MySQL to be healthy
      - name: Wait for Database to be ready
        run: |
          until docker compose -p suite-${{ matrix.suite }} exec db \
                  mysqladmin ping -h "localhost" --silent; do
            echo "Waiting for MySQL…"
            sleep 5
          done

          until docker compose -p suite-${{ matrix.suite }} exec db \
                  mysql -uroot -proot -e "USE local"; do
            echo "Waiting for local database…"
            sleep 5
          done

      # 5) prep Joomla
      - name: Copy default configuration.php
        run: docker compose -p suite-${{ matrix.suite }} exec joomla \
               cp /var/www/html/tests/configuration.php /var/www/html/configuration.php

      - name: Remove Installation Directory
        run: docker compose -p suite-${{ matrix.suite }} exec joomla \
               rm -rf /var/www/html/installation

      - name: Wait for Joomla Web to be ready
        run: |
          until curl --fail --silent --output /dev/null http://localhost:8080; do
            echo "Waiting for Joomla Web…"
            sleep 5
          done

      # 6) install Mothership into this container
      - name: Install Mothership via CLI
        run: |
          docker compose -p suite-${{ matrix.suite }} exec joomla \
            bash -lc "chmod +x cli/joomla.php && \
                      php cli/joomla.php extension:install --path tmp/mothership"

      # 7) run *this* suite
      - name: Run Codeception ${{ matrix.suite }} Tests
        run: |
          docker compose -p suite-${{ matrix.suite }} exec --user root joomla \
            bash -lc "/root/.composer/vendor/bin/codecept run ${{ matrix.suite }} -d -f"

      # 8) tear it down (always)
      - name: Teardown
        if: always()
        run: docker compose -p suite-${{ matrix.suite }} down -v
